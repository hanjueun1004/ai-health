<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í•œì˜ì› ê±´ê°• ì»¨ì„¤íŒ… (Q&A ë¶„ë¦¬)</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f5f0; 
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
        }
        .consult-container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 25px 30px;
            width: 100%;
            max-width: 750px; 
            box-sizing: border-box;
            border-top: 5px solid #5D4037; 
        }
        .step-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #e0e0e0; 
            display: none; 
        }
        .step-section:nth-last-of-type(1), /* ë§ˆì§€ë§‰ step-section (Q&A) */
        .step-section:nth-last-of-type(2) { /* ê·¸ ì• step-section (ê²°ê³¼) */
            border-bottom: none;
        }
        .step-section.active {
            display: block; 
        }
        h2.main-title { 
            color: #3E2723; 
            margin-top: 0;
            margin-bottom: 25px; 
            text-align: center;
            font-size: 1.8em;
            font-weight: 700;
        }
        h3.section-title { 
            color: #4E342E; 
            margin-top: 0;
            margin-bottom: 20px; 
            font-size: 1.4em;
            font-weight: 500;
            padding-bottom: 10px;
            border-bottom: 2px solid #8D6E63; 
        }
        .option-group { 
            margin-bottom: 20px;
        }
        .option-group label.group-label { 
            display: block;
            margin-bottom: 12px; 
            font-weight: 500;
            color: #6D4C41; 
            font-size: 1.05em;
        }
        .options-list { 
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        .options-list label {
            background-color: #F5F5F5; 
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid #E0E0E0;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-weight: normal; 
            display: flex; 
            align-items: center;
            font-size: 0.95em;
            color: #424242;
        }
        .options-list label:hover {
            background-color: #E0E0E0;
            border-color: #BDBDBD;
        }
        .options-list input[type="radio"], .options-list input[type="checkbox"] {
            margin-right: 12px; 
            width: auto;
            flex-shrink: 0; 
        }
        input[type="text"], input[type="number"], select, textarea {
            padding: 12px; 
            border: 1px solid #BCAAA4; 
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1em;
            background-color: #FAFAFA;
            color: #333;
        }
        textarea { min-height: 80px; }
        button {
            background-color: #6D4C41; 
            color: white;
            border: none;
            padding: 12px 20px; 
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 500;
            margin-top: 15px; 
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #4E342E; 
        }
        button.prev-btn {
            background-color: #A1887F; 
        }
        button.prev-btn:hover {
            background-color: #8D6E63;
        }
        .form-navigation { 
            display: flex;
            justify-content: space-between;
            align-items: center; /* ë²„íŠ¼ ì„¸ë¡œ ì •ë ¬ */
            margin-top: 25px;
        }
        .form-navigation.center-button { /* ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬ìš© */
            justify-content: center;
        }

        #progress-indicator {
            display: flex;
            justify-content: space-around; /* ê° ìŠ¤í… ê°„ê²© ë™ì¼í•˜ê²Œ */
            flex-wrap: wrap; /* ì‘ì€ í™”ë©´ì—ì„œ ì¤„ë°”ê¿ˆ í—ˆìš© */
            margin-bottom: 30px;
            padding: 10px;
            background-color: #ECEFF1;
            border-radius: 8px;
        }
        .progress-step {
            color: #78909C;
            font-size: 0.85em; /* ê¸€ì í¬ê¸° ì•½ê°„ ì¤„ì„ */
            padding: 5px 8px; /* íŒ¨ë”© ì•½ê°„ ì¤„ì„ */
            border-radius: 4px;
            text-align: center;
            flex-basis: 0; /* flex ì•„ì´í…œ ê¸°ë³¸ í¬ê¸° 0 */
            flex-grow: 1; /* ê°€ëŠ¥í•œ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            margin: 2px; /* ìŠ¤í… ê°„ ê°„ê²© */
        }
        .progress-step.active {
            background-color: #5D4037;
            color: white;
            font-weight: bold;
        }
        
        #results-section { display: none; } 
        .results-content { 
            background-color: #FFF8E1; 
            border: 1px solid #FFECB3;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 20px; /* Q&A ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
        }
        .results-content h4 {
            color: #795548; 
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.2em;
            border-bottom: 1px solid #D7CCC8;
            padding-bottom: 5px;
        }
        .results-content ul { list-style-type: disc; margin-left: 20px; padding-left: 0; }
        .results-content li { margin-bottom: 8px; line-height: 1.6; }
        .final-warning {
            color: #BF360C; 
            font-weight: bold;
            margin-top: 20px; /* Q&A ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
            text-align: center;
            font-size: 0.95em;
            padding: 12px;
            background-color: #FFCCBC;
            border: 1px solid #FFAB91;
            border-radius: 5px;
        }

        #qna-chatbot-interface { /* Q&A ì±—ë´‡ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” div */
            margin-top: 30px;
            border-top: 3px solid #8D6E63; 
            padding-top: 20px;
        }
        #qnaChatBox {
            height: 350px; /* ë†’ì´ ì•½ê°„ ì¦ê°€ */
            background-color: #F5F5F5; 
            border: 1px solid #D7CCC8; 
            border-radius: 5px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .qna-message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%; 
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .qna-user-message {
            background-color: #A1887F; 
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .qna-bot-message {
            background-color: #EFEBE9; 
            color: #3E2723; 
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .qna-input-container { display: flex; padding: 10px 0; }
        #qnaUserInput {
            flex-grow: 1;
            margin-right: 10px;
            border-color: #BCAAA4; 
        }
        #qnaSendButton { background-color: #5D4037; font-size: 1em; }
        #qnaDisclaimer {
            font-size:0.85em; color:#757575; text-align:center; margin-top:10px;
        }
        #goToQnAPageButton { /* Q&A ì‹œì‘ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
            background-color: #4CAF50; 
            display: block; 
            padding: 15px 30px; 
            font-size: 1.15em; /* ê¸€ì í¬ê¸° í‚¤ì›€ */
            width: auto; /* ë‚´ìš©ì— ë§ê²Œ */
        }
        #goToQnAPageButton:hover { background-color: #388E3C; }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="consult-container">
        <h2 class="main-title">ë‚˜ë§Œì˜ ê±´ê°• ì£¼ì¹˜ì˜ í•œì˜ë´‡ğŸ‘©â€âš•ï¸</h2>

        <div id="progress-indicator">
            <span class="progress-step active" data-step="0">ê¸°ë³¸ì •ë³´</span>
            <span class="progress-step" data-step="1">ì²´ì§ˆë¬¸ì§„ â‘ </span>
            <span class="progress-step" data-step="2">ì²´ì§ˆë¬¸ì§„ â‘¡</span>
            <span class="progress-step" data-step="3">ì²´ì§ˆë¬¸ì§„ â‘¢</span>
            <span class="progress-step" data-step="4">í˜„ì¬ìƒíƒœ</span>
            <span class="progress-step" data-step="5">ìƒí™œìŠµê´€</span>
            <span class="progress-step" data-step="6">ê²°ê³¼ë³´ê¸°</span> <span class="progress-step" data-step="7">Q&A ìƒë‹´</span> </div>

        <div class="step-section active" id="step-0">
            <h3 class="section-title">ì‹œì‘í•˜ê¸°: ê¸°ë³¸ ì •ë³´ ì…ë ¥</h3>
             <p style="background-color:#EFEBE9; padding:10px; border-radius:5px; margin-bottom:20px; font-size:0.9em;">
                ì•ˆë…•í•˜ì„¸ìš”! ë‚˜ë§Œì˜ ê±´ê°• ì£¼ì¹˜ì˜ í•œì˜ë´‡ğŸ˜Šì…ë‹ˆë‹¤.<br>
ë¨¼ì € í•œì˜í•™ ë°ì´í„°ì— ê¸°ë°˜í•œ ê°„ë‹¨í•œ ê±´ê°• ì²´í¬ë¥¼ ì§„í–‰í• ê²Œìš”.
ë¶„ì„ì´ ëª¨ë‘ ëë‚˜ë©´, ê²°ê³¼ë¥¼ ë³´ë©´ì„œ ë¬´ì—‡ì´ë“  ììœ ë¡­ê²Œ ë¬¼ì–´ë³´ì‹¤ ìˆ˜ ìˆì–´ìš”.
ê·¸ëŸ¼, ì¤€ë¹„ë˜ì…¨ì„ ë•Œ ê²€ì‚¬ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”. ğŸ˜Š           </p>
            <div class="option-group">
                <label class="group-label" for="gender">ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”:</label>
                <select id="gender" style="padding:10px; width: auto; min-width: 150px;">
                    <option value="">ì„ íƒ</option>
                    <option value="male">ë‚¨ì„±</option>
                    <option value="female">ì—¬ì„±</option>
                </select>
            </div>
            <div class="option-group">
                <label class="group-label" for="age">ë§Œ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:</label>
                <input type="number" id="age" min="1" max="120" placeholder="ì˜ˆ: 35">
            </div>
            <div class="form-navigation">
                <span></span>
                <button onclick="nextStep(0)">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </div>
        </div>

        <div class="step-section" id="step-1">
            <h3 class="section-title">ì²´ì§ˆ ë¬¸ì§„ (1/3)</h3>
            <div class="option-group">
                <label class="group-label">1. ì „ì²´ì ì¸ ì²´ê²©ê³¼ ì¸ìƒì€ ì–´ë–»ìŠµë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_1" value="TE">ê³¨ê²©ì´ í¬ê³  ì²´ê²©ì´ ë‹¤ë¶€ì§€ë©°, ì•ˆì •ê° ìˆëŠ” ì¸ìƒì´ë‹¤.</label>
                    <label><input type="radio" name="sq_1" value="SE">ì²´êµ¬ê°€ ì‘ê³  ì•„ë‹´í•˜ë©°, ë‹¤ì†Œ ì•½í•´ ë³´ì´ê±°ë‚˜ ë¶€ë“œëŸ¬ìš´ ì¸ìƒì´ë‹¤.</label>
                    <label><input type="radio" name="sq_1" value="SY">ìƒì²´ê°€ ë°œë‹¬í•˜ê³  ë‚ ë µí•´ ë³´ì´ë©°, ë¯¼ì²©í•˜ê³  ì˜ˆë¦¬í•œ ì¸ìƒì´ë‹¤.</label>
                    <label><input type="radio" name="sq_1" value="TY">ìƒì²´ê°€ ë°œë‹¬í•˜ê³  ìœ„ì—„ ìˆì–´ ë³´ì´ë‚˜, í•˜ì²´ê°€ ë‹¤ì†Œ ë¹ˆì•½í•´ ë³´ì¸ë‹¤.</label>
                </div>
            </div>
            <div class="option-group">
                <label class="group-label">2. ì–¼êµ´ ëª¨ì–‘ê³¼ ì´ëª©êµ¬ë¹„ëŠ” ì–´ë–¤ í¸ì…ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_2" value="TE">ì–¼êµ´ì´ ë‘¥ê¸€ê±°ë‚˜ ë„“ì í•˜ë©°, ì´ëª©êµ¬ë¹„ê°€ í¬ê³  ëšœë ·í•œ í¸ì´ë‹¤.</label>
                    <label><input type="radio" name="sq_2" value="SE">ì–¼êµ´ì´ ê°¸ë¦„í•˜ê±°ë‚˜ ê³„ë€í˜•ì´ë©°, ì´ëª©êµ¬ë¹„ê°€ ì˜¤ë°€ì¡°ë°€í•˜ê³  ì„¬ì„¸í•œ í¸ì´ë‹¤.</label>
                    <label><input type="radio" name="sq_2" value="SY">ì–¼êµ´ì´ ë‹¤ì†Œ ê¸¸ê±°ë‚˜ ì—­ì‚¼ê°í˜•ì´ë©°, ëˆˆë§¤ê°€ ì˜¬ë¼ê°€ê³  ì½”ê°€ ë‚ ì¹´ë¡œìš´ í¸ì´ë‹¤.</label>
                    <label><input type="radio" name="sq_2" value="TY">ì´ë§ˆê°€ ë„“ê³  ëˆˆë¹›ì´ ê°•í•˜ë©°, ì „ì²´ì ìœ¼ë¡œ ì„ ì´ êµµê³  ê°•í•œ ì¸ìƒì„ ì¤€ë‹¤.</label>
                </div>
            </div>
             <div class="option-group">
                <label class="group-label">3. í‰ì†Œ ë§ê³¼ í–‰ë™ì€ ì–´ë–¤ í¸ì…ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_3" value="TE">ë§ìˆ˜ê°€ ì ê³  í–‰ë™ì´ ì‹ ì¤‘í•˜ë©°, ê³¼ë¬µí•˜ê³  ë¯¿ìŒì§ìŠ¤ëŸ½ë‹¤.</label>
                    <label><input type="radio" name="sq_3" value="SE">ë§ì´ ì¡°ìš©í•˜ê³  ë¶€ë“œëŸ¬ìš°ë©°, í–‰ë™ì´ ì°¨ë¶„í•˜ê³  ì¡°ì‹¬ìŠ¤ëŸ½ë‹¤.</label>
                    <label><input type="radio" name="sq_3" value="SY">ë§ì´ ë¹ ë¥´ê³  ëª…ì¾Œí•˜ë©°, í–‰ë™ì´ ë¯¼ì²©í•˜ê³  í™œë°œí•˜ë‹¤.</label>
                    <label><input type="radio" name="sq_3" value="TY">ë§ì— ê¶Œìœ„ê°€ ìˆê³  ì§ì„ ì ì´ë©°, í–‰ë™ì´ ì ê·¹ì ì´ê³  ì£¼ë„ì ì´ë‹¤.</label>
                </div>
            </div>
            <div class="form-navigation">
                <button class="prev-btn" onclick="prevStep(1)">ì´ì „ ë‹¨ê³„ë¡œ</button>
                <button onclick="nextStep(1)">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </div>
        </div>
        
        <div class="step-section" id="step-2">
            <h3 class="section-title">ì²´ì§ˆ ë¬¸ì§„ (2/3)</h3>
             <div class="option-group">
                <label class="group-label">4. ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì„ ë•Œ ì£¼ë¡œ ì–´ë–»ê²Œ ë°˜ì‘í•©ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_4" value="TE">ì†ìœ¼ë¡œ ì‚­ì´ê±°ë‚˜, ì‹œê°„ì´ ì§€ë‚˜ë©´ ìŠìœ¼ë ¤ê³  ë…¸ë ¥í•œë‹¤.</label>
                    <label><input type="radio" name="sq_4" value="SE">ë¶ˆì•ˆí•´í•˜ê±°ë‚˜ ê±±ì •ì´ ë§ì•„ì§€ë©°, ì‰½ê²Œ ì ì„ ì´ë£¨ì§€ ëª»í•œë‹¤.</label>
                    <label><input type="radio" name="sq_4" value="SY">í™”ë¥¼ ë‚´ê±°ë‚˜ ì§œì¦ì„ ë‚´ë©°, ê°ì •ì„ ì¦‰ê°ì ìœ¼ë¡œ í‘œí˜„í•œë‹¤.</label>
                    <label><input type="radio" name="sq_4" value="TY">ìƒí™©ì„ ë¶„ì„í•˜ê³  í•´ê²°í•˜ë ¤ í•˜ë©°, ë•Œë¡œëŠ” ë…ë‹¨ì ìœ¼ë¡œ í–‰ë™í•  ìˆ˜ ìˆë‹¤.</label>
                </div>
            </div>
            <div class="option-group">
                <label class="group-label">5. í‰ì†Œ ì†Œí™” ìƒíƒœì™€ ì‹ìš•ì€ ì–´ë–»ìŠµë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_5" value="TE">ì†Œí™”ë ¥ì´ ì¢‹ê³  ì‹ìš•ì´ ì™•ì„±í•˜ë©°, ê³¼ì‹í•˜ëŠ” ê²½í–¥ì´ ìˆë‹¤.</label>
                    <label><input type="radio" name="sq_5" value="SE">ì†Œí™”ê¸°ê°€ ì•½í•˜ê³  ì‹ìš•ì´ ì ì€ í¸ì´ë©°, ì°¬ ìŒì‹ì„ ë¨¹ìœ¼ë©´ ë¶ˆí¸í•˜ë‹¤.</label>
                    <label><input type="radio" name="sq_5" value="SY">ì†Œí™”ëŠ” ì˜ ë˜ë‚˜, ê¸‰í•˜ê²Œ ë¨¹ëŠ” í¸ì´ê³ , ë§¤ìš´ ìŒì‹ì„ ì¦ê²¨ ì°¾ëŠ”ë‹¤.</label>
                    <label><input type="radio" name="sq_5" value="TY">ì†Œí™”ì— í° ë¬¸ì œëŠ” ì—†ìœ¼ë‚˜, ê¸°ë¦„ì§„ ìŒì‹ì€ ë¶€ë‹´ìŠ¤ëŸ¬ìš¸ ìˆ˜ ìˆë‹¤.</label>
                </div>
            </div>
            <div class="option-group">
                <label class="group-label">6. ë°°ë³€ ìŠµê´€ì€ ì–´ë–¤ í¸ì…ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_6" value="TE">ëŒ€ë³€ì´ ë¬´ë¥´ê³  ì–‘ì´ ë§ì€ í¸ì´ê±°ë‚˜, ë³€ë¹„ì™€ ì„¤ì‚¬ê°€ ë²ˆê°ˆì•„ ë‚˜íƒ€ë‚  ìˆ˜ ìˆë‹¤.</label>
                    <label><input type="radio" name="sq_6" value="SE">ëŒ€ë³€ì´ ê°€ëŠ˜ê±°ë‚˜ ë¬´ë¥´ë©°, ì‹ ê²½ ì“°ë©´ ë³€ë¹„ë‚˜ ì„¤ì‚¬ê°€ ìƒê¸°ê¸° ì‰½ë‹¤.</label>
                    <label><input type="radio" name="sq_6" value="SY">ëŒ€ë³€ì´ ì‹œì›í•˜ê²Œ ë‚˜ì˜¤ë‚˜, ì—´ì´ ë§ìœ¼ë©´ ë³€ë¹„ê°€ ìƒê¸°ê¸° ì‰½ë‹¤.</label>
                    <label><input type="radio" name="sq_6" value="TY">ëŒ€ë³€ì€ ë³´í†µì´ë‚˜, ëª¸ ìƒíƒœì— ë”°ë¼ ë³€í™”ê°€ ìˆì„ ìˆ˜ ìˆë‹¤.</label>
                </div>
            </div>
            <div class="form-navigation">
                <button class="prev-btn" onclick="prevStep(2)">ì´ì „ ë‹¨ê³„ë¡œ</button>
                <button onclick="nextStep(2)">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </div>
        </div>

        <div class="step-section" id="step-3">
            <h3 class="section-title">ì²´ì§ˆ ë¬¸ì§„ (3/3)</h3>
            <div class="option-group">
                <label class="group-label">7. í‰ì†Œ ë•€ì€ ì–´ëŠ ì •ë„ë¡œ í˜ë¦¬ì‹­ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_7" value="TE">ë•€ì´ ë§ì€ í¸ì´ê³ , ê±´ê°•í•  ë•Œ ë•€ì´ ì˜ ë‚˜ë©´ ëª¸ì´ ê°€ë³ë‹¤.</label>
                    <label><input type="radio" name="sq_7" value="SE">ë•€ì´ ê±°ì˜ ì—†ê³ , ë•€ì„ ë§ì´ í˜ë¦¬ë©´ ì‰½ê²Œ ì§€ì¹œë‹¤.</label>
                    <label><input type="radio" name="sq_7" value="SY">ë”ìœ„ë¥¼ ë§ì´ íƒ€ì§€ë§Œ, ë•€ì€ ìƒê°ë³´ë‹¤ ë§ì§€ ì•Šê±°ë‚˜ íŠ¹ì • ë¶€ìœ„ì—ë§Œ ë‚œë‹¤.</label>
                    <label><input type="radio" name="sq_7" value="TY">ë•€ì´ ì ì€ í¸ì´ë‚˜, ì •ì‹ ì  ê¸´ì¥ ì‹œì— ë•€ì´ ë‚  ìˆ˜ ìˆë‹¤.</label>
                </div>
            </div>
            <div class="option-group">
                <label class="group-label">8. ì¶”ìœ„ì™€ ë”ìœ„ ì¤‘ ì–´ëŠ ê²ƒì„ ë” íƒ€ëŠ” í¸ì…ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_8" value="TE">ë”ìœ„ë³´ë‹¤ëŠ” ì¶”ìœ„ë¥¼ ë” ëª» ê²¬ë””ëŠ” í¸ì´ë‹¤.</label>
                    <label><input type="radio" name="sq_8" value="SE">ì¶”ìœ„ë¥¼ ë§ì´ íƒ€ê³ , ì†ë°œì´ ì°¬ ê²½ìš°ê°€ ë§ë‹¤.</label>
                    <label><input type="radio" name="sq_8" value="SY">ë”ìœ„ë¥¼ ë§ì´ íƒ€ê³ , ì‹œì›í•œ ê²ƒì„ ì¢‹ì•„í•œë‹¤.</label>
                    <label><input type="radio" name="sq_8" value="TY">ë”ìœ„ë³´ë‹¤ëŠ” ì¶”ìœ„ì— ê°•í•œ í¸ì´ë‹¤.</label>
                </div>
            </div>
             <div class="option-group">
                <label class="group-label">9. ê±´ê°•ì´ ì¢‹ì§€ ì•Šì„ ë•Œ ì£¼ë¡œ ì–´ë–¤ ì¦ìƒì´ ë‚˜íƒ€ë‚©ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_9" value="TE">í˜¸í¡ê¸°(ê¸°ì¹¨, ê°€ë˜)ë‚˜ ìˆœí™˜ê¸°(ê³ í˜ˆì••, ì¤‘í’) ê³„í†µì˜ ë¬¸ì œê°€ ìƒê¸°ê¸° ì‰½ë‹¤.</label>
                    <label><input type="radio" name="sq_9" value="SE">ì†Œí™”ê¸°(ì†Œí™”ë¶ˆëŸ‰, ì„¤ì‚¬)ë‚˜ ì‹ ê²½ì„± ì§ˆí™˜(ë¶ˆì•ˆ, ë¶ˆë©´)ì´ ìƒê¸°ê¸° ì‰½ë‹¤.</label>
                    <label><input type="radio" name="sq_9" value="SY">ë¹„ë‡¨ìƒì‹ê¸°(ë°©ê´‘ì—¼, ìš”í†µ)ë‚˜ ì—´ì„± ì§ˆí™˜(ë‘í†µ, í”¼ë¶€ ë°œì§„)ì´ ìƒê¸°ê¸° ì‰½ë‹¤.</label>
                    <label><input type="radio" name="sq_9" value="TY">êµ¬í† ë‚˜ ì‹ë„ ì—­ë¥˜ ë“± ìƒë¶€ ì†Œí™”ê¸° ë¬¸ì œë‚˜, í•˜ì²´ ë¬´ë ¥ê°ì´ ìƒê¸°ê¸° ì‰½ë‹¤.</label>
                </div>
            </div>
             <div class="option-group">
                <label class="group-label">10. í‰ì†Œ ìì£¼ ëŠë¼ëŠ” ë¶ˆí¸ê°ì´ë‚˜ ì•½í•œ ë¶€ìœ„ëŠ” ì–´ë””ì…ë‹ˆê¹Œ?</label>
                <div class="options-list">
                    <label><input type="radio" name="sq_10" value="TE">ë°°ê°€ ë”ë¶€ë£©í•˜ê±°ë‚˜, í”¼ë¶€ ì§ˆí™˜ì´ ì˜ ìƒê¸´ë‹¤.</label>
                    <label><input type="radio" name="sq_10" value="SE">ì†ë°œì´ ì°¨ê³ , ê¸°ìš´ì´ ì—†ìœ¼ë©°, ì¶”ìœ„ë¥¼ ì˜ íƒ„ë‹¤.</label>
                    <label><input type="radio" name="sq_10" value="SY">ê°€ìŠ´ì´ ë‹µë‹µí•˜ê±°ë‚˜, ì˜†êµ¬ë¦¬ê°€ ê²°ë¦¬ê³ , ë³€ë¹„ ê²½í–¥ì´ ìˆë‹¤.</label>
                    <label><input type="radio" name="sq_10" value="TY">ëª©ëœë¯¸ê°€ ë»£ë»£í•˜ê±°ë‚˜, ë‹¤ë¦¬ì— í˜ì´ ì—†ê³ , êµ¬ì—­ì§ˆì´ ì˜ ë‚œë‹¤.</label>
                </div>
            </div>
            <div class="form-navigation">
                <button class="prev-btn" onclick="prevStep(3)">ì´ì „ ë‹¨ê³„ë¡œ</button>
                <button onclick="nextStep(3)">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </div>
        </div>
        
        <div class="step-section" id="step-4">
            <h3 class="section-title">í˜„ì¬ ê±´ê°• ìƒíƒœ</h3>
            <div class="option-group multi-choice">
                <label class="group-label">í˜„ì¬ ê°€ì¥ ë¶ˆí¸í•˜ê±°ë‚˜ ìì£¼ ê²ªëŠ” ì¦ìƒì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš” (ì¤‘ë³µ ê°€ëŠ¥):</label>
                <div class="options-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <label><input type="checkbox" name="symptom" value="ë§Œì„± í”¼ë¡œ">ë§Œì„± í”¼ë¡œ</label>
                    <label><input type="checkbox" name="symptom" value="ì†Œí™” ë¶ˆëŸ‰">ì†Œí™” ë¶ˆëŸ‰/ì†ì“°ë¦¼</label>
                    <label><input type="checkbox" name="symptom" value="ë‘í†µ">ì¦ì€ ë‘í†µ</label>
                    <label><input type="checkbox" name="symptom" value="ìˆ˜ë©´ ì¥ì• ">ìˆ˜ë©´ ì¥ì•  (ë¶ˆë©´/ê³¼ë‹¤ìˆ˜ë©´)</label>
                    <label><input type="checkbox" name="symptom" value="ê·¼ê³¨ê²©ê³„ í†µì¦">ì–´ê¹¨/ëª© ê²°ë¦¼, ìš”í†µ</label>
                    <label><input type="checkbox" name="symptom" value="ë°°ë³€ ë¬¸ì œ">ë³€ë¹„/ì„¤ì‚¬</label>
                    <label><input type="checkbox" name="symptom" value="í”¼ë¶€ ë¬¸ì œ">í”¼ë¶€ íŠ¸ëŸ¬ë¸” (ê°€ë ¤ì›€, ë°œì§„ ë“±)</label>
                    <label><input type="checkbox" name="symptom" value="ê°ê¸° ì¦ìƒ">ì¦ì€ ê°ê¸°, ë¹„ì—¼</label>
                    <label><input type="checkbox" name="symptom" value="ë¶€ì¢…">ë¶€ì¢… (ì–¼êµ´, ì†ë°œ ë“±)</label>
                    <label><input type="checkbox" name="symptom" value="ì‹¬ë¦¬ì  ë¬¸ì œ">ìŠ¤íŠ¸ë ˆìŠ¤, ë¶ˆì•ˆ, ìš°ìš¸ê°</label>
                </div>
            </div>
            <div class="option-group">
                 <label class="group-label" for="other_symptoms">ê¸°íƒ€ ë¶ˆí¸í•œ ì¦ìƒì´ë‚˜ íŠ¹ë³„íˆ ìƒë‹´í•˜ê³  ì‹¶ì€ ë‚´ìš©ì´ ìˆë‹¤ë©´ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”:</label>
                 <textarea id="other_symptoms" rows="3" placeholder="ì˜ˆ) ìµœê·¼ 3ê°œì›” ì „ë¶€í„° ì•„ì¹¨ì— ì¼ì–´ë‚  ë•Œ ì†ê°€ë½ ë§ˆë””ê°€ ë»£ë»£í•˜ê³ , ì˜¤í›„ê°€ ë˜ë©´ ê´œì°®ì•„ì§‘ë‹ˆë‹¤."></textarea>
            </div>
            <div class="form-navigation">
                <button class="prev-btn" onclick="prevStep(4)">ì´ì „ ë‹¨ê³„ë¡œ</button>
                <button onclick="nextStep(4)">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </div>
        </div>

        <div class="step-section" id="step-5">
            <h3 class="section-title">ìƒí™œ ìŠµê´€ ì ê²€</h3>
            <div class="option-group">
                <label class="group-label" for="sleep_hours">í•˜ë£¨ í‰ê·  ìˆ˜ë©´ ì‹œê°„ì€ ì–´ëŠ ì •ë„ ë˜ì‹œë‚˜ìš”?</label>
                <div class="slider-container">
                    <input type="range" id="sleep_hours" name="sleep_hours_range" min="3" max="10" value="7" step="0.5" oninput="document.getElementById('sleep_value_display').textContent = this.value;">
                    <span id="sleep_value_display" class="slider-value">7</span> ì‹œê°„
                </div>
            </div>
            <div class="option-group">
                <label class="group-label">ì‹ì‚¬ëŠ” ê·œì¹™ì ìœ¼ë¡œ í•˜ì‹œëŠ” í¸ì¸ê°€ìš”?</label>
                <div class="options-list">
                    <label><input type="radio" name="regular_meals" value="ë§¤ìš° ê·œì¹™ì ">ë§¤ìš° ê·œì¹™ì  (ì •í•´ì§„ ì‹œê°„ì— ì˜ ì±™ê²¨ ë¨¹ìŒ)</label>
                    <label><input type="radio" name="regular_meals" value="ëŒ€ì²´ë¡œ ê·œì¹™ì ">ëŒ€ì²´ë¡œ ê·œì¹™ì  (ê°€ë” ë¶ˆê·œì¹™)</label>
                    <label><input type="radio" name="regular_meals" value="ë¶ˆê·œì¹™ì ">ë¶ˆê·œì¹™ì  (ìì£¼ ê±°ë¥´ê±°ë‚˜ ì‹œê°„ì´ ì¼ì •ì¹˜ ì•ŠìŒ)</label>
                    <label><input type="radio" name="regular_meals" value="ë§¤ìš° ë¶ˆê·œì¹™ì ">ë§¤ìš° ë¶ˆê·œì¹™ì  (ì‹ì‚¬ ì‹œê°„ì´ ê±°ì˜ ì—†ìŒ)</label>
                </div>
            </div>
             <div class="option-group">
                <label class="group-label">ì¼ì£¼ì¼ì— 30ë¶„ ì´ìƒ ìš´ë™í•˜ì‹œëŠ” íšŸìˆ˜ëŠ” ì–´ëŠ ì •ë„ì¸ê°€ìš”?</label>
                <div class="options-list">
                    <label><input type="radio" name="exercise_freq" value="ê±°ì˜ ì•ˆí•¨">ê±°ì˜ ì•ˆí•¨ (ì›” 1íšŒ ë¯¸ë§Œ)</label>
                    <label><input type="radio" name="exercise_freq" value="ì£¼ 1-2íšŒ">ì£¼ 1-2íšŒ</label>
                    <label><input type="radio" name="exercise_freq" value="ì£¼ 3-4íšŒ">ì£¼ 3-4íšŒ</label>
                    <label><input type="radio" name="exercise_freq" value="ì£¼ 5íšŒ ì´ìƒ">ì£¼ 5íšŒ ì´ìƒ</label>
                </div>
            </div>
             <div class="option-group">
                <label class="group-label" for="stress_level">ìµœê·¼ í•œ ë‹¬ê°„ ëŠë¼ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€ì€ ì–´ëŠ ì •ë„ì¸ê°€ìš”? (1: ë§¤ìš° ë‚®ìŒ ~ 10: ë§¤ìš° ë†’ìŒ)</label>
                <div class="slider-container">
                     <input type="range" id="stress_level" name="stress_level_range" min="1" max="10" value="5" step="1" oninput="document.getElementById('stress_value_display').textContent = this.value;">
                     <span id="stress_value_display" class="slider-value">5</span> ì 
                </div>
            </div>
            <div class="form-navigation">
                <button class="prev-btn" onclick="prevStep(5)">ì´ì „ ë‹¨ê³„ë¡œ</button>
                <button onclick="processAndShowResults()">ì»¨ì„¤íŒ… ê²°ê³¼ë³´ê¸°</button> </div>
        </div>
        
        <div class="step-section" id="step-6"> 
            <h3 class="section-title">AI ê±´ê°• ì»¨ì„¤íŒ… ê²°ê³¼</h3>
            <div class="results-content">
                <h4>í™˜ìë‹˜ ê¸°ë³¸ ì •ë³´</h4>
                <p id="result_basic_info"></p>
                <h4>ì‚¬ìƒì²´ì§ˆ ë¶„ì„ (ì˜ˆë¹„)</h4>
                <p id="result_sasang_type"></p>
                <p id="result_sasang_desc" style="font-size:0.95em; color:#555;"></p>
                <h4>í˜„ì¬ ê±´ê°• ìƒíƒœ ìš”ì•½</h4>
                <p id="result_symptoms"></p>
                <h4>ìƒí™œ ìŠµê´€ ë¶„ì„ ìš”ì•½</h4>
                <p id="result_lifestyle"></p>
                <h4>ì¢…í•© ê±´ê°• ì»¨ì„¤íŒ…</h4>
                <div id="result_general_advice"></div>
                <h4>ì²´ì§ˆ ë§ì¶¤ ìƒì„¸ ì»¨ì„¤íŒ…</h4>
                <div id="result_custom_advice"></div>
            </div>
            <p class="final-warning">ë³¸ AI ì»¨ì„¤íŒ…ì€ ì˜í•™ì ì¸ ì§„ë‹¨ì´ë‚˜ ì¹˜ë£Œë¥¼ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê±´ê°•ì— ëŒ€í•œ ì •í™•í•œ íŒë‹¨ê³¼ ì¹˜ë£ŒëŠ” ë°˜ë“œì‹œ ì „ë¬¸ ì˜ë£Œê¸°ê´€ì„ ë°©ë¬¸í•˜ì—¬ ì˜ì‚¬ ë˜ëŠ” í•œì˜ì‚¬ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
            
            <div class="form-navigation center-button"> <button id="goToQnAPageButton">AI ê±´ê°• Q&A ì‹œì‘í•˜ê¸°</button>
            </div>
            <div class="form-navigation" style="margin-top:10px;">
                 <button class="prev-btn" onclick="prevStep(6)">ì´ì „ (ìƒí™œìŠµê´€ìœ¼ë¡œ)</button>
                 <button onclick="restartConsult()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘</button>
            </div>
        </div>

        <div class="step-section" id="step-7">
            <h3 class="section-title">AI ê±´ê°• Q&A ìƒë‹´ì‹¤</h3>
            <div id="qna-chatbot-interface"> 
                <div class="chat-box" id="qnaChatBox">
                    </div>
                <div class="qna-input-container">
                    <input type="text" id="qnaUserInput" placeholder="ê±´ê°• ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="qnaSendButton">ì§ˆë¬¸í•˜ê¸°</button>
                </div>
                <p id="qnaDisclaimer">ë³¸ Q&AëŠ” ì¼ë°˜ì ì¸ ê±´ê°• ì •ë³´ë¥¼ ì œê³µí•˜ë©°, ì˜í•™ì  ì§„ë‹¨ì´ë‚˜ ì²˜ë°©ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="form-navigation">
                <button class="prev-btn" onclick="prevStep(7)">ì»¨ì„¤íŒ… ê²°ê³¼ ë‹¤ì‹œë³´ê¸°</button>
                <button onclick="restartConsult()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘</button>
            </div>
        </div>

    </div>

    <script>
    // --- ì „ì—­ ì˜¤ë¥˜ í•¸ë“¤ëŸ¬ ---
    window.onerror = function(message, source, lineno, colno, error) {
        alert(`ì£„ì†¡í•©ë‹ˆë‹¤. í˜ì´ì§€ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\në©”ì‹œì§€: ${message}\nì†ŒìŠ¤: ${source} (ì¤„: ${lineno})`);
        console.error("ì „ì—­ ì˜¤ë¥˜:", { message, source, lineno, colno, error });
        return true; 
    };
    // alert("AI í•œì˜ì› ê±´ê°• ì»¨ì„¤íŒ… ì‹œìŠ¤í…œì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."); // DOMContentLoadedì—ì„œ ì•ˆë‚´

    try { 
        console.log("SCRIPT START: Main logic initializing...");

        const sections = Array.from(document.querySelectorAll('.consult-container > .step-section'));
        const progressSteps = Array.from(document.querySelectorAll('#progress-indicator > .progress-step'));
        let currentStep = 0; // í˜„ì¬ í™œì„±í™”ëœ ë‹¨ê³„ì˜ ì¸ë±ìŠ¤ (0ë¶€í„° ì‹œì‘)
        let diagnosedSasangType = null; 
        let collectedUserData = {}; 

        let qnaChatBox, qnaUserInput, qnaSendButton, goToQnAPageButton; 

        const GEMINI_API_KEY = "AIzaSyBuKOj0HLgoQf3J5pQbkq0yBj21Ru5uCA0"; // <--- ì‚¬ìš©ìì˜ Gemini API í‚¤ ì…ë ¥ ê³µê°„
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        const sasangQuestionIds = ['sq_1', 'sq_2', 'sq_3', 'sq_4', 'sq_5', 'sq_6', 'sq_7', 'sq_8', 'sq_9', 'sq_10'];
        const sasangWeights = { 
            sq_1: { TE: 2, SE: 1, SY: 1, TY: 1 }, sq_2: { TE: 2, SE: 1, SY: 1, TY: 2 },
            sq_3: { TE: 2, SE: 1, SY: 1, TY: 1 }, sq_4: { TE: 1, SE: 2, SY: 2, TY: 1 },
            sq_5: { TE: 2, SE: 2, SY: 1, TY: 1 }, sq_6: { TE: 1, SE: 1, SY: 2, TY: 0 },
            sq_7: { TE: 2, SE: 2, SY: 1, TY: 1 }, sq_8: { TE: 1, SE: 2, SY: 2, TY: 1 },
            sq_9: { TE: 2, SE: 2, SY: 1, TY: 2 }, sq_10: { TE: 1, SE: 2, SY: 2, TY: 1 }
        };

        function updateProgressIndicator() {
            // console.log("Updating progress indicator for step: ", currentStep);
            if (!progressSteps || progressSteps.length === 0) return;
            progressSteps.forEach((stepEl, index) => {
                // data-step ê°’ì€ 0ë¶€í„° ì‹œì‘í•˜ëŠ” ë°˜ë©´, currentStepë„ 0ë¶€í„° ì‹œì‘
                // HTMLì˜ data-stepê³¼ currentStepì„ ì§ì ‘ ë¹„êµ
                if(stepEl) stepEl.classList.toggle('active', parseInt(stepEl.dataset.step) === currentStep);
            });
        }

        function displayStep(stepIndexToShow) {
            // console.log(`Displaying step: ${stepIndexToShow}`);
            if (!sections || sections.length === 0) { return; }
            sections.forEach((section, index) => {
                if(section) section.classList.toggle('active', index === stepIndexToShow);
            });
            currentStep = stepIndexToShow;
            updateProgressIndicator();
            window.scrollTo(0, 0); 
        }

        function validateStep(stepIndexToValidate) {
            // console.log(`Validating step ${stepIndexToValidate}`);
            try {
                if (stepIndexToValidate === 0) { 
                    const gender = document.getElementById('gender').value;
                    const age = document.getElementById('age').value;
                    if (!gender) { alert('í™˜ìë¶„ì˜ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì‹­ì‹œì˜¤.'); return false; }
                    if (!age) { alert('í™˜ìë¶„ì˜ ë§Œ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì‹­ì‹œì˜¤.'); return false; }
                    const ageNum = parseInt(age);
                    if (isNaN(ageNum) || ageNum <= 0 || ageNum > 120) {
                        alert('ë§Œ ë‚˜ì´ëŠ” 1ì„¸ë¶€í„° 120ì„¸ ì‚¬ì´ì˜ ìœ íš¨í•œ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì‹­ì‹œì˜¤.'); return false;
                    }
                } else if (stepIndexToValidate >= 1 && stepIndexToValidate <=3) { 
                    let questionsToCheck = [];
                    if (stepIndexToValidate === 1) questionsToCheck = ['sq_1', 'sq_2', 'sq_3'];
                    if (stepIndexToValidate === 2) questionsToCheck = ['sq_4', 'sq_5', 'sq_6'];
                    if (stepIndexToValidate === 3) questionsToCheck = ['sq_7', 'sq_8', 'sq_9', 'sq_10'];
                    
                    for (const qId of questionsToCheck) {
                        if (!document.querySelector(`input[name="${qId}"]:checked`)) {
                            alert(`ì²´ì§ˆ ë¬¸ì§„ ${qId.split('_')[1]}ë²ˆ í•­ëª©ì— ë‹µë³€í•´ì£¼ì‹œë©´ ì§„ë‹¨ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.`); return false;
                        }
                    }
                } else if (stepIndexToValidate === 5) { // ìƒí™œìŠµê´€ í˜ì´ì§€ ìœ íš¨ì„± ê²€ì‚¬
                     if (!document.querySelector('input[name="regular_meals"]:checked')) { alert('í‰ì†Œ ì‹ìŠµê´€ì˜ ê·œì¹™ì„±ì„ ì„ íƒí•´ì£¼ì‹­ì‹œì˜¤.'); return false;}
                     if (!document.querySelector('input[name="exercise_freq"]:checked')) { alert('í‰ì†Œ ì£¼ê°„ ìš´ë™ íšŸìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì‹­ì‹œì˜¤.'); return false;}
                }
                return true;
            } catch(e) {
                alert(`ì •ë³´ í™•ì¸ ì¤‘ ì˜¤ë¥˜ (${stepIndexToValidate}ë‹¨ê³„): ${e.message}`);
                console.error(`Error in validateStep for step ${stepIndexToValidate}:`, e);
                return false;
            }
        }

        function nextStep(currentStepIndex) {
            if (!validateStep(currentStepIndex)) { return; }
             // sections.length -1 ì€ ê²°ê³¼&QnA ì„¹ì…˜(step-6)ì„ ê°€ë¦¬í‚´. 
             // step-7 (ìƒˆë¡œìš´ Q&A ì „ìš©)ìœ¼ë¡œ ê°€ë ¤ë©´ sections.lengthëŠ” 8ì´ì–´ì•¼ í•¨. (ì¸ë±ìŠ¤ 0~7)
            if (currentStepIndex < sections.length - 2) { // ê²°ê³¼ë³´ê¸° ë° Q&A ì „ìš© í˜ì´ì§€ ì´ì „ê¹Œì§€
                displayStep(currentStepIndex + 1);
            } else {
                console.warn("nextStep: Already at or before the results/Q&A step. Use showResultsAndQnA or specific navigation.");
            }
        }

        function prevStep(currentStepIndex) {
            if (currentStepIndex > 0) {
                displayStep(currentStepIndex - 1);
            }
        }
        
        function collectData() { /* ì´ì „ê³¼ ë™ì¼ */
            const data = {};
            try {
                data.gender = document.getElementById('gender').value;
                data.age = document.getElementById('age').value;
                sasangQuestionIds.forEach(id => {
                    const selected = document.querySelector(`input[name="${id}"]:checked`);
                    data[id] = selected ? selected.value : null;
                });
                data.symptoms = [];
                document.querySelectorAll('input[name="symptom"]:checked').forEach(cb => data.symptoms.push(cb.value));
                data.other_symptoms = document.getElementById('other_symptoms').value.trim();
                data.sleep_hours = document.getElementById('sleep_hours').value;
                const regularMealsEl = document.querySelector('input[name="regular_meals"]:checked');
                data.regular_meals = regularMealsEl ? regularMealsEl.value : "ì‘ë‹µ ì—†ìŒ";
                const exerciseFreqEl = document.querySelector('input[name="exercise_freq"]:checked');
                data.exercise_freq = exerciseFreqEl ? exerciseFreqEl.value : "ì‘ë‹µ ì—†ìŒ";
                data.stress_level = document.getElementById('stress_level').value;
            } catch (e) { console.error("Error in collectData:", e); }
            return data;
        }
        
        function escapeHtml(unsafe) { /* ì´ì „ê³¼ ë™ì¼ */
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function processAndShowResults() { // í•¨ìˆ˜ ì´ë¦„ ë³€ê²½
            if (!validateStep(5)) { return; } // step-5 (ìƒí™œìŠµê´€) ìœ íš¨ì„± ê²€ì‚¬
            alert('ëª¨ë“  ë¬¸í•­ì— ë‹µë³€í•´ì£¼ì…¨ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì»¨ì„¤íŒ… ê²°ê³¼ë¥¼ ì¤€ë¹„í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
            
            try {
                collectedUserData = collectData(); 

                const sasangScores = { TE: 0, SE: 0, SY: 0, TY: 0 };
                sasangQuestionIds.forEach(id => {
                    const userAnswerType = collectedUserData[id]; 
                    if (userAnswerType && sasangWeights[id] && sasangWeights[id][userAnswerType] !== undefined) {
                        sasangScores[userAnswerType] += sasangWeights[id][userAnswerType];
                    } else if (userAnswerType && ["TE", "SE", "SY", "TY"].includes(userAnswerType)) {
                        if(sasangWeights[id] && sasangWeights[id][userAnswerType] === undefined){
                            sasangScores[userAnswerType] += 1; 
                        }
                    }
                });

                let maxScore = 0;
                let finalSasangTypes = [];
                for (const type in sasangScores) {
                    if (sasangScores[type] > maxScore) {
                        maxScore = sasangScores[type];
                        finalSasangTypes = [type];
                    } else if (sasangScores[type] === maxScore && maxScore > 0) {
                        finalSasangTypes.push(type);
                    }
                }
                
                diagnosedSasangType = (finalSasangTypes.length === 1 && maxScore > 2) ? finalSasangTypes[0] : null;

                let sasangResultText = "";
                let sasangDescText = "";
                if (maxScore <= 2 || finalSasangTypes.length === 0) { 
                     sasangResultText = "<strong>íŒë‹¨ ë³´ë¥˜ ë˜ëŠ” ë³µí•© ì²´ì§ˆ ê°€ëŠ¥ì„±</strong>";
                     sasangDescText = "ì…ë ¥í•´ì£¼ì‹  ì •ë³´ë§Œìœ¼ë¡œëŠ” ëª…í™•í•œ ì‚¬ìƒì²´ì§ˆì„ íŒë‹¨í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ê° ì²´ì§ˆì˜ íŠ¹ì§•ì´ ë³µí•©ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê±°ë‚˜, ì •ë³´ê°€ ë¶€ì¡±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³´ë‹¤ ì •í™•í•œ ì§„ë‹¨ì€ í•œì˜ì‚¬ì™€ ìƒë‹´í•´ì£¼ì„¸ìš”.";
                } else if (finalSasangTypes.length === 1) {
                    sasangResultText = `í™˜ìë¶„ê»˜ì„œëŠ” <strong>${finalSasangTypes[0]}</strong>ì˜ ê²½í–¥ì„±ì´ ë†’ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. (ì˜ˆìƒ ì ìˆ˜: ${maxScore})`;
                    if (finalSasangTypes[0] === "TY" && maxScore <= 4) { 
                        sasangResultText += "<br><small>(ë‹¨, íƒœì–‘ì¸ì€ ë°œìƒ ë¹ˆë„ê°€ ë§¤ìš° ë‚®ì€ ì²´ì§ˆë¡œ ì•Œë ¤ì ¸ ìˆìœ¼ë©°, í˜„ì¬ ì •ë³´ë§Œìœ¼ë¡œëŠ” í™•ì‹ í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì˜ ì •ë°€í•œ ì§„ë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤.)</small>";
                    }
                    if (finalSasangTypes[0] === "TE") sasangDescText = "íƒœìŒì¸ì€ ì¼ë°˜ì ìœ¼ë¡œ ì²´ê²©ì´ ì¢‹ê³  ì„±ê²©ì´ ê¾¸ì¤€í•˜ë©°, ê°„(è‚) ê¸°ëŠ¥ì´ ê°•í•˜ê³  í(è‚º) ê¸°ëŠ¥ì´ ì•½í•œ ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. ìˆœí™˜ê¸°ê³„ ì§ˆí™˜ì´ë‚˜ ëŒ€ì‚¬ ì¦í›„êµ°ì— ì£¼ì˜í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.";
                    else if (finalSasangTypes[0] === "SE") sasangDescText = "ì†ŒìŒì¸ì€ ì†Œí™”ê¸°ê°€ ì•½í•˜ê³  ë‚´ì„±ì ì´ë©° ê¼¼ê¼¼í•œ ì„±í–¥ì„ ë³´ì…ë‹ˆë‹¤. ì‹ ì¥(è…) ê¸°ëŠ¥ì´ ê°•í•˜ê³  ë¹„ìœ„(è„¾èƒƒ) ê¸°ëŠ¥ì´ ì•½í•œ ê²½í–¥ì´ ìˆì–´, ì†Œí™”ë¶ˆëŸ‰ì´ë‚˜ ëƒ‰ì¦ì— ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.";
                    else if (finalSasangTypes[0] === "SY") sasangDescText = "ì†Œì–‘ì¸ì€ ìƒì²´ê°€ ë°œë‹¬í•˜ê³  ì„±ê²©ì´ í™œë°œí•˜ë©° ì†”ì§í•©ë‹ˆë‹¤. ë¹„ìœ„(è„¾èƒƒ) ê¸°ëŠ¥ì´ ê°•í•˜ê³  ì‹ ì¥(è…) ê¸°ëŠ¥ì´ ì•½í•œ ê²½í–¥ì´ ìˆì–´, ëª¸ì— ì—´ì´ ë§ê³  ë³€ë¹„ë‚˜ ë¹„ë‡¨ê¸°ê³„ ì§ˆí™˜ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                    else if (finalSasangTypes[0] === "TY") sasangDescText = "íƒœì–‘ì¸ì€ í(è‚º) ê¸°ëŠ¥ì´ ê°•í•˜ê³  ê°„(è‚) ê¸°ëŠ¥ì´ ì•½í•˜ë©°, ìƒì²´ê°€ ë°œë‹¬í•˜ê³  ì§„ì·¨ì ì¸ ê¸°ìƒì´ íŠ¹ì§•ì…ë‹ˆë‹¤. ì†Œí™”ê¸° ì§ˆí™˜ì´ë‚˜ í•˜ì²´ ì•½í™”ì— ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.";

                } else { 
                    sasangResultText = `í™˜ìë¶„ê»˜ì„œëŠ” <strong>${finalSasangTypes.join(' ë˜ëŠ” ')} ë³µí•© ê²½í–¥</strong>ì„ ë³´ì´ì‹­ë‹ˆë‹¤. (ê° ì˜ˆìƒ ì ìˆ˜: ${maxScore})`;
                    sasangDescText = "ì—¬ëŸ¬ ì²´ì§ˆì˜ íŠ¹ì§•ì„ í•¨ê»˜ ê°€ì§€ê³  ê³„ì‹¤ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. ê° ì²´ì§ˆì˜ ì¥ì ì„ ê³ ë£¨ ê°–ì¶”ì—ˆê±°ë‚˜, í˜¹ì€ íŠ¹ì • ì²´ì§ˆì˜ ì•½ì ì„ ë‹¤ë¥¸ ì²´ì§ˆì˜ íŠ¹ì„±ì´ ë³´ì™„í•´ì£¼ëŠ” í˜•íƒœë¡œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ì‚¬í•­ì€ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
                }

                document.getElementById('result_basic_info').innerHTML = `<strong>ì„±ë³„:</strong> ${collectedUserData.gender === 'male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}, <strong>ë‚˜ì´:</strong> ë§Œ ${collectedUserData.age}ì„¸`;
                document.getElementById('result_sasang_type').innerHTML = sasangResultText;
                document.getElementById('result_sasang_desc').innerHTML = `<p>${sasangDescText}</p>`;

                let symptomsOutput = "íŠ¹ë³„íˆ í˜¸ì†Œí•˜ëŠ” ì¦ìƒì€ ì—†ìœ¼ì‹  ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.";
                let collectedSymptoms = [];
                if (collectedUserData.symptoms && collectedUserData.symptoms.length > 0) {
                    collectedSymptoms = Array.isArray(collectedUserData.symptoms) ? collectedUserData.symptoms : [collectedUserData.symptoms];
                }
                if (collectedUserData.other_symptoms && collectedUserData.other_symptoms.toLowerCase() !== 'ì—†ìŒ' && collectedUserData.other_symptoms.length > 0) {
                    collectedSymptoms.push(`ê¸°íƒ€ íŠ¹ì´ì‚¬í•­: ${escapeHtml(collectedUserData.other_symptoms)}`);
                }
                if(collectedSymptoms.length > 0) {
                     symptomsOutput = "<strong>í˜„ì¬ ì£¼ë¡œ ë¶ˆí¸ê°ì„ ëŠë¼ì‹œëŠ” ë¶€ë¶„:</strong> " + collectedSymptoms.join(', ');
                }
                document.getElementById('result_symptoms').innerHTML = symptomsOutput;

                let lifestyleOutput = `<ul>
                    <li><strong>ìˆ˜ë©´:</strong> í•˜ë£¨ í‰ê·  ${collectedUserData.sleep_hours}ì‹œê°„</li>
                    <li><strong>ì‹ìŠµê´€ ê·œì¹™ì„±:</strong> ${collectedUserData.regular_meals}</li>
                    <li><strong>ì£¼ê°„ ìš´ë™ íšŸìˆ˜:</strong> ${collectedUserData.exercise_freq}</li>
                    <li><strong>ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€:</strong> ${collectedUserData.stress_level}ì  (10ì  ë§Œì )</li>
                </ul>`;
                document.getElementById('result_lifestyle').innerHTML = lifestyleOutput;

                let generalAdviceHTML = "<ul>";
                if (parseFloat(collectedUserData.sleep_hours) < 6.5) generalAdviceHTML += "<li><strong>ìˆ˜ë©´ ê°œì„ :</strong> í•˜ë£¨ 7-8ì‹œê°„ì˜ ì§ˆ ì¢‹ì€ ìˆ˜ë©´ì„ ìœ„í•´ ë…¸ë ¥í•´ì£¼ì„¸ìš”. ì ë“¤ê¸° ì „ ìŠ¤ë§ˆíŠ¸í° ì‚¬ìš©ì„ ì¤„ì´ê³ , ì¼ì •í•œ ì‹œê°„ì— ì ìë¦¬ì— ë“œëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>";
                if (collectedUserData.regular_meals && collectedUserData.regular_meals.toLowerCase().includes('ë¶ˆê·œì¹™ì ')) generalAdviceHTML += "<li><strong>ê·œì¹™ì ì¸ ì‹ì‚¬:</strong> ì •í•´ì§„ ì‹œê°„ì— ê· í˜• ì¡íŒ ì‹ì‚¬ë¥¼ í•˜ëŠ” ê²ƒì´ ì†Œí™”ê¸° ê±´ê°•ê³¼ ì‹ ì²´ ë¦¬ë“¬ ìœ ì§€ì— ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. ì•„ì¹¨ ì‹ì‚¬ë¥¼ ê±°ë¥´ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>";
                if (collectedUserData.exercise_freq === 'ê±°ì˜ ì•ˆí•¨') generalAdviceHTML += "<li><strong>ì‹ ì²´ í™œë™ ëŠ˜ë¦¬ê¸°:</strong> ì¼ìƒìƒí™œì—ì„œ í™œë™ëŸ‰ì„ ëŠ˜ë¦¬ê³ , ì£¼ 2-3íšŒ ê°€ë²¼ìš´ ìš´ë™(ì‚°ì±…, ìŠ¤íŠ¸ë ˆì¹­ ë“±)ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”. ê¾¸ì¤€í•¨ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</li>";
                if (parseInt(collectedUserData.stress_level) >= 7) generalAdviceHTML += "<li><strong>ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬:</strong> ë†’ì€ ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ë§Œë³‘ì˜ ê·¼ì›ì…ë‹ˆë‹¤. ëª…ìƒ, ì‹¬í˜¸í¡, ì·¨ë¯¸í™œë™, ì¶©ë¶„í•œ íœ´ì‹ ë“± ìì‹ ì—ê²Œ ë§ëŠ” í•´ì†Œë²•ì„ ì°¾ì•„ ê¾¸ì¤€íˆ ì‹¤ì²œí•˜ì„¸ìš”.</li>";
                
                if (collectedUserData.other_symptoms && collectedUserData.other_symptoms.toLowerCase() !== 'ì—†ìŒ' && collectedUserData.other_symptoms.length > 2) {
                     generalAdviceHTML += `<li><strong>ê¸°íƒ€ ì‚¬í•­ í™•ì¸:</strong> ì–¸ê¸‰í•´ì£¼ì‹  '${escapeHtml(collectedUserData.other_symptoms)}'ì— ëŒ€í•´ì„œëŠ”, ì´ê²ƒì´ ì¼ì‹œì ì¸ì§€ ì§€ì†ì ì¸ì§€, ë‹¤ë¥¸ ì¦ìƒê³¼ ì—°ê´€ì´ ìˆëŠ”ì§€ ë“±ì„ ê³ ë ¤í•˜ì—¬ í•„ìš”ì‹œ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì—¬ ì •í™•í•œ ì›ì¸ê³¼ ê´€ë¦¬ë²•ì„ ì•Œì•„ë³´ì‹œëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.</li>`;
                }

                if (generalAdviceHTML === "<ul>") generalAdviceHTML = "<p>ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ìƒí™œìŠµê´€ì„ ê°€ì§€ê³  ê³„ì‹  ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì•ìœ¼ë¡œë„ ê¾¸ì¤€íˆ ê±´ê°• ê´€ë¦¬ì— í˜ì¨ì£¼ì„¸ìš”.</p>";
                else generalAdviceHTML += "</ul>";
                document.getElementById('result_general_advice').innerHTML = generalAdviceHTML;

                let customAdviceHTML = "";
                if (diagnosedSasangType) { 
                    const type = diagnosedSasangType;
                    customAdviceHTML += `<h4>${type} í™˜ìë¶„ì„ ìœ„í•œ ë§ì¶¤ ì»¨ì„¤íŒ… (ìš”ì•½)</h4>`;
                    switch(type) {
                        case "TE": customAdviceHTML += `<p><strong>íƒœìŒì¸:</strong> ê³¼ì‹ ì£¼ì˜, ìœ ì‚°ì†Œ ìš´ë™ê³¼ ê·¼ë ¥ ìš´ë™ì„ ë³‘í–‰í•˜ì„¸ìš”. ì½©, ë‘ë¶€, ì†Œê³ ê¸°, ë¬´, ë„ë¼ì§€ ë“± ì„­ì·¨. ë•€ì„ ì ì ˆíˆ ë‚´ëŠ” ê²ƒì´ ë„ì›€ë©ë‹ˆë‹¤.</p>`; break;
                        case "SE": customAdviceHTML += `<p><strong>ì†ŒìŒì¸:</strong> ëª¸ì„ ë”°ëœ»í•˜ê²Œ, ì†Œí™” ì˜ë˜ëŠ” ë”°ëœ»í•œ ìŒì‹ì„ ë“œì„¸ìš”. ë‹­ê³ ê¸°, ìƒê°•, ì¸ì‚¼ ë“±ì´ ì¢‹ìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>`; break;
                        case "SY": customAdviceHTML += `<p><strong>ì†Œì–‘ì¸:</strong> ì‹œì›í•œ ìŒì‹, í•˜ì²´ ìš´ë™ ê¶Œì¥. ë¼ì§€ê³ ê¸°, ì˜¤ì´, ë…¹ë‘ ë“±. ë§ˆìŒì„ ì°¨ë¶„íˆ í•˜ê³  ìˆ˜ë¶„ ì„­ì·¨ ì¶©ë¶„íˆ í•˜ì„¸ìš”.</p>`; break;
                        case "TY": customAdviceHTML += `<p><strong>íƒœì–‘ì¸:</strong> ë‹´ë°±í•˜ê³  ì„œëŠ˜í•œ ìŒì‹, í•˜ì²´ ê°•í™”. í•´ì‚°ë¬¼, ë©”ë°€ ë“±. ë§ˆìŒ ì•ˆì •ê³¼ ë‹¨ì „í˜¸í¡ì´ ê¶Œì¥ë©ë‹ˆë‹¤.</p>`; break;
                    }
                } else {
                     customAdviceHTML = "<p>ì—¬ëŸ¬ ì²´ì§ˆì˜ íŠ¹ì„±ì´ ë³µí•©ì ì´ê±°ë‚˜ ì •ë³´ê°€ ë¶€ì¡±í•˜ì—¬, íŠ¹ì • ì²´ì§ˆ ë§ì¶¤ ì¡°ì–¸ë³´ë‹¤ëŠ” ì¼ë°˜ì ì¸ ê±´ê°• ìˆ˜ì¹™ ì¤€ìˆ˜ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>";
                }
                document.getElementById('result_custom_advice').innerHTML = customAdviceHTML;

                // ê²°ê³¼ í˜ì´ì§€(step-6) í‘œì‹œ. sections ë°°ì—´ì—ì„œ step-6ì€ ì¸ë±ìŠ¤ 6.
                displayStep(6); 
                // alert("ì»¨ì„¤íŒ… ê²°ê³¼ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ê¼¼ê¼¼íˆ í™•ì¸í•´ì£¼ì„¸ìš”."); // ì´ì œ Q&A ë²„íŠ¼ì„ ëˆ„ë¥´ë„ë¡ ìœ ë„

            } catch(e) {
                 alert("ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜: " + e.message);
                 console.error("Error in processAndShowResults:", e, e.stack);
            }
        }
        
        // --- Q&A ì±—ë´‡ ê´€ë ¨ í•¨ìˆ˜ ---
        function appendQnAMessage(text, sender) { /* ì´ì „ê³¼ ë™ì¼ */
            if (!qnaChatBox) return;
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('qna-message', sender === 'user' ? 'qna-user-message' : 'qna-bot-message');
            messageDiv.innerHTML = sender === 'bot' ? text.replace(/\n/g, '<br>') : escapeHtml(text);
            qnaChatBox.appendChild(messageDiv);
            qnaChatBox.scrollTop = qnaChatBox.scrollHeight;
        }

        async function handleQnAUserInput() { /* ì´ì „ê³¼ ë™ì¼ (í”„ë¡¬í”„íŠ¸ì— collectedUserData.other_symptoms ë°˜ì˜) */
            if (!qnaUserInput || !qnaSendButton || !GEMINI_API_KEY) {
                if (!GEMINI_API_KEY) {
                    appendQnAMessage("ì£„ì†¡í•©ë‹ˆë‹¤, AI ë‹µë³€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì½”ë“œ ë‚´ GEMINI_API_KEY ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.", "bot");
                }
                if (qnaUserInput) qnaUserInput.disabled = false;
                if (qnaSendButton) qnaSendButton.disabled = false;
                return;
            }
            const userText = qnaUserInput.value.trim();
            if (userText === '') return;

            appendQnAMessage(userText, 'user');
            qnaUserInput.value = '';
            qnaUserInput.disabled = true;
            qnaSendButton.disabled = true;

            const loadingMsgEl = appendQnAMessage("AIê°€ ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...", 'bot');

            try {
                let prompt = `ë‹¹ì‹ ì€ í•œì˜í•™, ì‚¬ìƒì˜í•™, ê·¸ë¦¬ê³  ì¼ë°˜ ê±´ê°• ìƒì‹ì— ëŒ€í•´ ë‹µë³€í•˜ëŠ” AI ê±´ê°• ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì´ì „ ì§„ë‹¨ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ë‹µë³€ì˜ ê¹Šì´ë¥¼ ë”í•´ì£¼ì„¸ìš”.\n`;
                prompt += `[ì‚¬ìš©ì ì´ì „ ì§„ë‹¨ ì •ë³´ ìš”ì•½]\n`;
                prompt += `- ë‚˜ì´: ${collectedUserData.age || 'ë¯¸ì…ë ¥'}ì„¸, ì„±ë³„: ${collectedUserData.gender === 'male' ? 'ë‚¨ì„±' : (collectedUserData.gender === 'female' ? 'ì—¬ì„±' : 'ë¯¸ì…ë ¥')}\n`;
                if (diagnosedSasangType) {
                    prompt += `- ì˜ˆë¹„ ì‚¬ìƒ ì²´ì§ˆ: ${diagnosedSasangType}\n`;
                } else {
                    prompt += `- ì˜ˆë¹„ ì‚¬ìƒ ì²´ì§ˆ: ëª…í™•íˆ í•œ ê°€ì§€ë¡œ ë¶„ë¥˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜ íŒë‹¨ ë³´ë¥˜\n`;
                }
                let symptomsForPrompt = "íŠ¹ë³„íˆ ì–¸ê¸‰ëœ ì£¼ìš” ì¦ìƒ ì—†ìŒ";
                let collectedSymptomsForPrompt = [];
                 if (collectedUserData.symptoms && collectedUserData.symptoms.length > 0) {
                    collectedSymptomsForPrompt = Array.isArray(collectedUserData.symptoms) ? collectedUserData.symptoms : [collectedUserData.symptoms];
                }
                // --- ìˆ˜ì •: other_symptomsë¥¼ í”„ë¡¬í”„íŠ¸ì— í™•ì‹¤íˆ í¬í•¨ ---
                if (collectedUserData.other_symptoms && collectedUserData.other_symptoms.toLowerCase() !== 'ì—†ìŒ' && collectedUserData.other_symptoms.length > 0) {
                    collectedSymptomsForPrompt.push(`(ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ ë° ìƒì„¸ ìš°ë ¤: ${escapeHtml(collectedUserData.other_symptoms)})`);
                }
                if(collectedSymptomsForPrompt.length > 0) {
                     symptomsForPrompt = collectedSymptomsForPrompt.join(', ');
                }
                prompt += `- ì£¼ìš” í˜¸ì†Œ ì¦ìƒ ë° ê¸°íƒ€ ì–¸ê¸‰: ${symptomsForPrompt}\n`;
                prompt += `[ì‚¬ìš©ì ì§ˆë¬¸]\n"${escapeHtml(userText)}"\n\n`;
                prompt += `[ë‹µë³€ ê°€ì´ë“œë¼ì¸]\n1. ì§ˆë¬¸ì— ëŒ€í•´ ì‰½ê³  ì¹œì ˆí•˜ê²Œ í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.\n2. í•œì˜í•™ì  ê´€ì ê³¼ ì¼ë°˜ ê±´ê°• ìƒì‹ì„ ê· í˜•ìˆê²Œ í¬í•¨í•´ì£¼ì„¸ìš”.\n3. ì‚¬ìš©ìì˜ ì²´ì§ˆì´ë‚˜ ì¦ìƒì„ ì°¸ê³ í•˜ì—¬ ë‹µë³€í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤. (ì˜ˆ: "OOOìœ¼ë¡œ ì§„ë‹¨ë˜ì‹  í™˜ìë¶„ì˜ ê²½ìš°..." ë˜ëŠ” "OO ì¦ìƒì„ ë§ì”€í•˜ì…¨ëŠ”ë°...")\n4. ë‹µë³€ì€ í•­ìƒ "ë³¸ ë‹µë³€ì€ ì¼ë°˜ì ì¸ ê±´ê°• ì •ë³´ì´ë©°, ì˜í•™ì  ì§„ë‹¨ì´ë‚˜ ì²˜ë°©ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ë‚´ìš©ì€ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì„¸ìš”."ë¼ëŠ” ë©´ì±… ì¡°í•­ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•´ì£¼ì„¸ìš”.`;

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (loadingMsgEl && loadingMsgEl.parentElement) loadingMsgEl.remove();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : `API ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`);
                }

                const responseData = await response.json();
                if (responseData.candidates && responseData.candidates[0] && responseData.candidates[0].content && responseData.candidates[0].content.parts && responseData.candidates[0].content.parts[0]) {
                    appendQnAMessage(responseData.candidates[0].content.parts[0].text, 'bot');
                } else if (responseData.promptFeedback && responseData.promptFeedback.blockReason) {
                     appendQnAMessage(`ìš”ì²­í•˜ì‹  ë‚´ìš©ì— ë‹µë³€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‚¬ìœ : ${responseData.promptFeedback.blockReason})`, 'bot');
                } else {
                    appendQnAMessage("ì£„ì†¡í•©ë‹ˆë‹¤. AIë¡œë¶€í„° ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'bot');
                }

            } catch (error) {
                console.error("Q&A API Error:", error);
                if (loadingMsgEl && loadingMsgEl.parentElement) loadingMsgEl.remove();
                appendQnAMessage("ì£„ì†¡í•©ë‹ˆë‹¤. AI ë‹µë³€ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message, 'bot');
            } finally {
                if(qnaUserInput) qnaUserInput.disabled = false;
                if(qnaSendButton) qnaSendButton.disabled = false;
                if(qnaUserInput) qnaUserInput.focus();
            }
        }

        function restartConsult() { /* ì´ì „ê³¼ ë™ì¼ */
            alert('ê±´ê°• ì»¨ì„¤íŒ…ì„ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤. ì…ë ¥í•˜ì‹  ë‚´ìš©ì€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.');
            try {
                document.getElementById('gender').value = '';
                document.getElementById('age').value = '';
                sasangQuestionIds.forEach(id => {
                    const radios = document.querySelectorAll(`input[name="${id}"]`);
                    if (radios) radios.forEach(radio => radio.checked = false);
                });
                document.querySelectorAll('input[name="symptom"]').forEach(cb => cb.checked = false);
                const otherSymptomsEl = document.getElementById('other_symptoms');
                if (otherSymptomsEl) otherSymptomsEl.value = '';
                const sleepSliderEl = document.getElementById('sleep_hours');
                const sleepDispEl = document.getElementById('sleep_value_display');
                if(sleepSliderEl && sleepDispEl) { sleepSliderEl.value = 7; sleepDispEl.textContent = '7';}
                document.querySelectorAll('input[name="regular_meals"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="exercise_freq"]').forEach(radio => radio.checked = false);
                const stressSliderEl = document.getElementById('stress_level');
                const stressDispEl = document.getElementById('stress_value_display');
                if(stressSliderEl && stressDispEl) { stressSliderEl.value = 5; stressDispEl.textContent = '5';}
                if (qnaChatBox) qnaChatBox.innerHTML = ''; 
                diagnosedSasangType = null; 
                collectedUserData = {}; 
                displayStep(0); 
            } catch (e) { alert("ë‹¤ì‹œ ì‹œì‘ ì¤‘ ì˜¤ë¥˜: " + e.message); console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("DOM fully loaded. Initializing application.");
                
                qnaChatbotSection = document.getElementById('qna-chatbot-interface'); // Q&A ì „ì²´ ì„¹ì…˜ì´ ì•„ë‹ˆë¼ ë‚´ë¶€ ì»¨í…Œì´ë„ˆ
                qnaChatBox = document.getElementById('qnaChatBox');
                qnaUserInput = document.getElementById('qnaUserInput');
                qnaSendButton = document.getElementById('qnaSendButton');
                goToQnAPageButton = document.getElementById('goToQnAPageButton');

                if (qnaSendButton) qnaSendButton.addEventListener('click', handleQnAUserInput);
                if (qnaUserInput) qnaUserInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) { 
                        event.preventDefault(); 
                        handleQnAUserInput();
                    }
                });
                if(goToQnAPageButton) {
                    goToQnAPageButton.addEventListener('click', function() {
                        // sections ë°°ì—´ì—ì„œ step-7ì€ ì¸ë±ìŠ¤ 7 (0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 8ë²ˆì§¸ ìš”ì†Œ)
                        displayStep(7); // Q&A ì „ìš© í˜ì´ì§€(step-7)ë¡œ ì´ë™
                        if (qnaChatBox && qnaChatBox.innerHTML.trim() === "") { 
                           appendQnAMessage("AI ê±´ê°• Q&A ìƒë‹´ì‹¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ì»¨ì„¤íŒ… ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê¶ê¸ˆí•œ ì ì´ë‚˜ ë‹¤ë¥¸ ê±´ê°• ê´€ë ¨ ì§ˆë¬¸ì„ í¸í•˜ê²Œ í•´ì£¼ì„¸ìš”. (ì˜ˆ: íƒœìŒì¸ì—ê²Œ ì¢‹ì€ ì°¨ëŠ” ë¬´ì—‡ì¸ê°€ìš”?)", 'bot');
                        }
                    });
                }
                
                const sleepSliderEl = document.getElementById('sleep_hours');
                const sleepDispEl = document.getElementById('sleep_value_display');
                if(sleepSliderEl && sleepDispEl) sleepDispEl.textContent = sleepSliderEl.value;

                const stressSliderEl = document.getElementById('stress_level');
                const stressDispEl = document.getElementById('stress_value_display');
                if(stressSliderEl && stressDispEl) stressDispEl.textContent = stressSliderEl.value;
                
                displayStep(0); 
                alert("AI í•œì˜ì› ê±´ê°• ì»¨ì„¤íŒ… í˜ì´ì§€ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì•ˆë‚´ì— ë”°ë¼ ì²« ë²ˆì§¸ ì •ë³´ë¶€í„° ì…ë ¥í•´ì£¼ì„¸ìš”.");
            } catch (e) {
                alert("í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: " + e.message);
                console.error("Error in DOMContentLoaded:", e, e.stack);
            }
        });

        console.log("SCRIPT END: Main logic parsed.");

    } catch (e) {
        alert("ì¹˜ëª…ì ì¸ JavaScript ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message + "\nì½˜ì†”ì„ í™•ì¸í•˜ê³ , íŒŒì¼ ì €ì¥ ë° ë¸Œë¼ìš°ì € ìƒíƒœë¥¼ ì ê²€í•´ì£¼ì„¸ìš”.");
        console.error("FATAL SCRIPT ERROR (outermost try-catch):", e, e.stack);
    }
    </script>
</body>
</html>